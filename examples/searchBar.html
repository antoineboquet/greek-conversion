<!DOCTYPE html>
<title>Search bar example &mdash; greek-conversion</title>
<link href="https://cdn.simplecss.org/simple.min.css" rel="stylesheet">
<style>
  label {
    user-select: none;
  }

  .icon {
    vertical-align: sub;
    padding-right: .25rem;
    display: inline-block;
    width: 1em;
    height: 1.3em;
    margin-right: 0.2rem;
    stroke-width: 0;
    stroke: currentColor;
    fill: currentColor;
  }

  nav a.current {
    color: var(--accent) !important;
    border-color: var(--accent) !important;
  }
  
  .notice {
    z-index: 999;
    position: absolute;
    margin-left: 5em;
    padding: .75em;
    font-size: .75em;
    box-shadow: rgba(50, 50, 93, .25) 0px 30px 60px -12px,
      rgba(0, 0, 0, .3) 0px 18px 36px -18px;
  }
</style>

<header>
  <nav>
    <a class="current" href="/searchBar.html">Search bar</a>
    <a href="/textTransliteration.html">Text transliteration</a>
    <a href="/playground.html">Playground</a>
    <a href="https://github.com/antoineboquet/greek-conversion" target="_blank"><svg class="icon" viewBox="0 0 32 32"><path d="M16 0.395c-8.836 0-16 7.163-16 16 0 7.069 4.585 13.067 10.942 15.182 0.8 0.148 1.094-0.347 1.094-0.77 0-0.381-0.015-1.642-0.022-2.979-4.452 0.968-5.391-1.888-5.391-1.888-0.728-1.849-1.776-2.341-1.776-2.341-1.452-0.993 0.11-0.973 0.11-0.973 1.606 0.113 2.452 1.649 2.452 1.649 1.427 2.446 3.743 1.739 4.656 1.33 0.143-1.034 0.558-1.74 1.016-2.14-3.554-0.404-7.29-1.777-7.29-7.907 0-1.747 0.625-3.174 1.649-4.295-0.166-0.403-0.714-2.030 0.155-4.234 0 0 1.344-0.43 4.401 1.64 1.276-0.355 2.645-0.532 4.005-0.539 1.359 0.006 2.729 0.184 4.008 0.539 3.054-2.070 4.395-1.64 4.395-1.64 0.871 2.204 0.323 3.831 0.157 4.234 1.026 1.12 1.647 2.548 1.647 4.295 0 6.145-3.743 7.498-7.306 7.895 0.574 0.497 1.085 1.47 1.085 2.963 0 2.141-0.019 3.864-0.019 4.391 0 0.426 0.288 0.925 1.099 0.768 6.354-2.118 10.933-8.113 10.933-15.18 0-8.837-7.164-16-16-16z"></path></svg>Github</a>
  </nav>
  <h1>Search bar example</h1>
  <p>
    This example shows how <code>greek-conversion</code> can be used
    to manage Greek input and fetch Greek data.
  </p>
</header>

<main>
  <input
    id="search-bar"
    type="search"
    placeholder="Type unaccented greek forms"
    style="width: 100%"
  />

  Input method:
  <span id="beta-code-notice" class="notice" hidden>
    <p style="margin:0 0 .75em 0">
      Since it's ugly, the beta code will be converted to Greek
      &mdash; in real time.<br />Here's the conversion chart:
    </p>
    <table style="margin:0">
      <tr style="background:white">
        <td><strong>A</strong> &rarr; Α</td>
        <td><strong>B</strong> &rarr; Β</td>
        <td><strong>G</strong> &rarr; Γ</td>
        <td><strong>D</strong> &rarr; Δ</td>
        <td><strong>E</strong> &rarr; Ε</td>
        <td><strong>Z</strong> &rarr; Ζ</td>
        <td><strong>H</strong> &rarr; Η</td>
        <td><strong>Q</strong> &rarr; Θ</td>
      </tr>
      <tr>
        <td><strong>I</strong> &rarr; Ι</td>
        <td><strong>K</strong> &rarr; Κ</td>
        <td><strong>L</strong> &rarr; Λ</td>
        <td><strong>M</strong> &rarr; Μ</td>
        <td><strong>N</strong> &rarr; Ν</td>
        <td><strong>C</strong> &rarr; Ξ</td>
        <td><strong>O</strong> &rarr; Ο</td>
        <td><strong>P</strong> &rarr; Π</td>
      </tr>
      <tr style="background:white">
        <td><strong>R</strong> &rarr; Ρ</td>
        <td><strong>S</strong> &rarr; Σ</td>
        <td><strong>T</strong> &rarr; Τ</td>
        <td><strong>U</strong> &rarr; Υ</td>
        <td><strong>F</strong> &rarr; Φ</td>
        <td><strong>X</strong> &rarr; Χ</td>
        <td><strong>Y</strong> &rarr; Ψ</td>
        <td><strong>W</strong> &rarr; Ω</td>
      </tr>
    </table>
  </span>
  <input
    type="radio"
    id="beta-code-radio"
    name="input-method"
    value="beta-code"
    checked
  />
  <label id="beta-code-label" for="beta-code-radio">beta code <sup>[?]</sup></label>

  <span id="translit-notice" class="notice" hidden>
    <p style="margin:0 0 .75em 0">
      You can type Greek naturally in transliteration mode.<br />
      Here's the conversion chart:
    </p>
    <table style="margin:0">
      <tr style="background:white">
        <td><strong>A</strong> &rarr; Α</td>
        <td><strong>B</strong> &rarr; Β</td>
        <td><strong>G</strong> &rarr; Γ</td>
        <td><strong>D</strong> &rarr; Δ</td>
        <td><strong>E</strong> &rarr; Ε</td>
        <td><strong>Z</strong> &rarr; Ζ</td>
        <td><strong>Ê</strong> &rarr; Η</td>
        <td><strong>TH</strong> &rarr; Θ</td>
      </tr>
      <tr>
        <td><strong>I</strong> &rarr; Ι</td>
        <td><strong>K</strong> &rarr; Κ</td>
        <td><strong>L</strong> &rarr; Λ</td>
        <td><strong>M</strong> &rarr; Μ</td>
        <td><strong>N</strong> &rarr; Ν</td>
        <td><strong>X</strong> &rarr; Ξ</td>
        <td><strong>O</strong> &rarr; Ο</td>
        <td><strong>P</strong> &rarr; Π</td>
      </tr>
      <tr style="background:white">
        <td><strong>R</strong> &rarr; Ρ</td>
        <td><strong>S</strong> &rarr; Σ</td>
        <td><strong>T</strong> &rarr; Τ</td>
        <td><strong>U</strong> &rarr; Υ</td>
        <td><strong>PH</strong> &rarr; Φ</td>
        <td><strong>CH</strong> &rarr; Χ</td>
        <td><strong>PS</strong> &rarr; Ψ</td>
        <td><strong>Ô</strong> &rarr; Ω</td>
      </tr>
    </table>
  </span>
  <input
    type="radio"
    id="translit-radio"
    name="input-method"
    value="transliteration"
  />
  <label id="translit-label" for="translit-radio">transliteration <sup>[?]</sup></label>

  <table id="words-table" hidden style="width:100%;table-layout:fixed">
    <thead>
      <tr>
        <th>Lemmata</th>
        <th style="width:50%">Morphology</th>
        <th>Dialect</th>
      </tr>
    </thead>
    <tbody id="words-list"></tbody>
    <tfoot>
      <tr>
        <th colspan="3" style="font-size:.75em;text-align:center">
          These data were collected using Morpheus, a morphological parsing and
          lemmatising tool provided by the
          <a href="https://www.perseus.tufts.edu/hopper/" target="_blank">Perseus Project</a>.
        </th>
      </tr>
    </tfoot>
  </table>
</main>

<script type="module">
  import {
    KeyType,
    toBetaCode,
    toGreek,
    toTransliteration
  } from 'https://www.unpkg.com/greek-conversion';

  function fetchMorpheus(betaCodeStr) {
    if (!betaCodeStr) {
      wordsTable.hidden = true;
      wordsList.innerHTML = '';
      return;
    }

    fetch(`https://www.perseus.tufts.edu/hopper/xmlmorph?lang=gr&lookup=${betaCodeStr}`)
      .then((response) => response.text())
      .then((data) => {
        const parser = new DOMParser();
        const xml = parser.parseFromString(data, 'application/xml');
        const analyses = xml.getElementsByTagName('analysis');

        let content = '';
        for (const el of analyses) {
          const lemma = el.getElementsByTagName('lemma')[0]?.textContent;
          const pos = el.getElementsByTagName('pos')[0]?.textContent;
          const person = el.getElementsByTagName('person')[0]?.textContent;
          const number = el.getElementsByTagName('number')[0]?.textContent;
          const tense = el.getElementsByTagName('tense')[0]?.textContent;
          const mood = el.getElementsByTagName('mood')[0]?.textContent;
          const voice = el.getElementsByTagName('voice')[0]?.textContent;
          const gender = el.getElementsByTagName('gender')[0]?.textContent;
          const form = el.getElementsByTagName('case')[0]?.textContent;
          const dialect = el.getElementsByTagName('dialect')[0]?.textContent;

          let morphology = [];
          if (['adj', 'noun', 'pron'].includes(pos)) {
            morphology = [number, gender, form];
          } else if (pos === 'verb') {
            morphology = [person, number, tense, mood, voice];
          }

          content += `
            <tr>
              <td><strong>${lemma}</strong></td>
              <td>(${pos}) ${morphology.filter(Boolean).join(', ')}</td>
              <td>${dialect}</td>
            </tr>
          `;
        }

        if (!content)
          content = `
            <tr>
              <td colspan=3 style="height:100px;text-align:center">
                No lemmata has been found for this form.
              </td>
            </tr>
          `;

        wordsTable.hidden = !content;
        wordsList.innerHTML = content;
      })
      .catch((e) => {
        console.error(e);
        wordsTable.hidden = false;
        wordsList.innerHTML = `
          <tr>
            <td colspan=3 style="height:100px;text-align:center">
              An error occured when attempting to collect data.
            </td>
          </tr>
        `;
      });
  }

  const searchBar = document.getElementById('search-bar');

  searchBar.setSelectionRange(searchBar.value.length, searchBar.value.length);
  searchBar.focus();

  const betaCodeRadio = document.getElementById('beta-code-radio');
  const betaCodeLabel = document.getElementById('beta-code-label');
  const betaCodeNotice = document.getElementById('beta-code-notice');
  const translitRadio = document.getElementById('translit-radio');
  const translitLabel = document.getElementById('translit-label');
  const translitNotice = document.getElementById('translit-notice');

  const wordsTable = document.getElementById('words-table');
  const wordsList = document.getElementById('words-list');

  const conversionOptions = {
    removeDiacritics: true,
    betaCodeStyle: { skipSanitization: true },
    transliterationStyle: {
      useCxOverMacron: true
    }
  };

  let inputMethod = betaCodeRadio.checked
    ? betaCodeRadio.value
    : translitRadio.value;

  betaCodeRadio.addEventListener('click', (e) => {
    inputMethod = e.target.value;
    searchBar.value = toGreek(
      searchBar.value,
      KeyType.TRANSLITERATION,
      conversionOptions
    );
  });

  translitRadio.addEventListener('click', (e) => {
    inputMethod = e.target.value;
    searchBar.value = toTransliteration(
      searchBar.value,
      KeyType.GREEK,
      conversionOptions
    );
  });

  betaCodeLabel.addEventListener('mouseenter', (e) => betaCodeNotice.hidden = false);
  betaCodeLabel.addEventListener('mouseleave', (e) => betaCodeNotice.hidden = true);

  translitLabel.addEventListener('mouseenter', (e) => translitNotice.hidden = false);
  translitLabel.addEventListener('mouseleave', (e) => translitNotice.hidden = true);

  if (searchBar.value) {
    const fromType = (inputMethod === 'beta-code')
      ? KeyType.GREEK
      : KeyType.TRANSLITERATION;
    fetchMorpheus(toBetaCode(searchBar.value, fromType, conversionOptions));
  }

  searchBar.addEventListener('input', (e) => {
    const selection = {
      start: e.target.selectionStart,
      end: e.target.selectionEnd
    };

    if (inputMethod === 'beta-code') {
      e.target.value = toGreek(
        e.target.value,
        KeyType.BETA_CODE,
        conversionOptions
      );
    }

    searchBar.setSelectionRange(selection.start, selection.end);
  });

  searchBar.addEventListener('keyup', (e) => {
    const fromType = (inputMethod === 'beta-code')
      ? KeyType.GREEK
      : KeyType.TRANSLITERATION;
    fetchMorpheus(toBetaCode(searchBar.value, fromType, conversionOptions));
  });
</script>
